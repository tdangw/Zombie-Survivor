<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zombie Survivor - Dang</title>
<style>
  body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; }
  canvas { display: block; margin: auto; background: radial-gradient(#333, #000); }
/* 🎯 Giao diện chính */
#ui {
  position: absolute;
  top: 1vh; /* cách top theo chiều cao màn hình */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.2rem; /* khoảng cách giữa các nút */
  padding: 0.7rem 1.5rem; 
  background: rgba(0, 0, 0, 0.7); /* nền trong suốt */
  border-radius: 0.75rem;
  width: 90%; /* tỷ lệ theo chiều ngang */
  max-width: 55rem; /* giới hạn tối đa */
  justify-content: center;
  z-index: 1000;
  flex-wrap: wrap;
}

/* 🔘 Nút trong UI (nhỏ gọn hơn nút mặc định) */
#ui button {
  padding: 0.6rem 0.6rem;
  font-size: 0.75rem;
  min-width: 6.5rem;
}

/* 🔘 Nút mặc định cho toàn giao diện */
button {
  font-family: 'Segoe UI', sans-serif;
  padding: 0.65rem 1.25rem;
  font-size: 1rem;
  cursor: pointer;
  min-width: 6.5rem;
  text-align: center;
  background-color: #1a2b33;
  border: 0.125rem solid #294e5a;
  border-radius: 0.5rem;
  color: #e0f7fa;
  transition: all 0.2s ease;
  box-shadow: 0 0.125rem 0.3rem rgba(0, 0, 0, 0.2);
}

/* 🔁 Hiệu ứng hover cho nút */
button:hover {
  background-color: #22404c;
  border-color: #3d6c78;
  color: #ffffff;
  transform: translateY(-0.06rem);
}

/* 🖱 Hiệu ứng khi click giữ */
button:active {
  transform: scale(0.97);
  box-shadow: 0 0.06rem 0.2rem rgba(0, 0, 0, 0.3);
}

/* ✳️ Nút đang active (được chọn) */
button.active {
  border-color: #00ffff;
  box-shadow: 0 0 0.625rem #00ffffaa;
}

/* ✅ Trạng thái active dùng cho nhiều thành phần */
.active {
  outline: 0.125rem solid gold;
  border-radius: 0.5rem;
}

/* 📊 Vùng hiển thị điểm số hoặc thông tin */
#score {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-width: 7.5rem;
  text-align: center;
  color: white;
  font-size: 1rem;
  padding: 0.3rem 0.6rem;
}

/* ℹ️ Tooltip container bao ngoài để hiển thị gợi ý */
.tooltip-container {
  position: relative;
  display: inline-block;
  margin: 0.4rem;
}

/* 📝 Tooltip nội dung khi hover */
.tooltip-container .tooltip-text {
  visibility: hidden;
  background-color: #222;
  color: #fff;
  text-align: left;
  border-radius: 0.375rem;
  padding: 0.5rem 0.6rem;
  position: absolute;
  z-index: 10;
  top: 110%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  width: 13.75rem;
  font-size: 0.8125rem;
  line-height: 1.5;
  white-space: pre-line;
  transition: opacity 0.3s ease;
  box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.5);
}

/* 🖱 Hiển thị tooltip khi hover vào container */
.tooltip-container:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

/* 🔄 Nút restart đặc biệt */
#restartBtn {
  padding: 0.75rem 1.75rem;
  font-weight: bold;
  background-color: #1c2e36;
  border: 0.125rem solid #3a6b75;
  border-radius: 0.5rem;
  font-size: 1rem;
  color: #aefeff;
  cursor: pointer;
  transition: 0.25s ease;
}

/* 🖱 Hover cho restart */
#restartBtn:hover {
  background-color: #28515f;
  color: white;
  transform: translateY(-0.06rem);
}
</style>

</head>
<body>
  <div id="ui">
<div class="tooltip-container">
  <button id="autoBtn">⚙️ Auto</button>
  <span class="tooltip-text">⚙️ Auto: Tự động tấn công zombie gần nhất khi bật</span>
</div>

<div class="tooltip-container">
  <button id="bladeBtn">🔪 Đao</button>
  <span class="tooltip-text">
    🔪 Kỹ năng Đao:bladeEndTime
    - Mỗi 2s tạo 1 đao xoay quanhbladeEndTime
    - Bay vào zombie gần nhấtbladeEndTime
    ⏱ Hiệu lực: 30sbladeEndTime
    ⚡ Tiêu hao: 6
  </span>
</div>

<div class="tooltip-container">
  <button id="swordBtn">⚔️ Kiếm</button>
  <span class="tooltip-text">
    ⚔️ Kỹ năng Kiếm:bladeEndTime
    - Mỗi 2s tạo 1 kiếm từ trên caobladeEndTime
    - Bay vào zombie gần nhấtbladeEndTime
    ⏱ Hiệu lực: 30sbladeEndTime
    ⚡ Tiêu hao: 6
  </span>
</div>

<div class="tooltip-container">
  <button id="fireBtn">🔥 Lửa</button>
  <span class="tooltip-text">
    🔥 Kỹ năng Lửa:bladeEndTime
    - Tạo 2 quả cầu lửa quay quanhbladeEndTime
    - Tiêu diệt zombie chạm vàobladeEndTime
    ⏱ Hiệu lực: 30sbladeEndTime
    ⚡ Tiêu hao: 5
  </span>
</div>

<div class="tooltip-container">
  <button id="iceBtn">❄️ Băng</button>
  <span class="tooltip-text">
    ❄️ Kỹ năng Băng (mở khóa Lv10):bladeEndTime
    - Tạo 4 quả cầu băng lớn xoay quanhbladeEndTime
    - Gây sát thương diện rộngbladeEndTime
    ⏱ Hiệu lực: 30sbladeEndTime
    ⚡ Tiêu hao: 8
  </span>
</div>

<div id="score">
  <div id="score-top">Điểm: 0 | ❤️: 3</div>
  <div id="score-bottom">Lv: 1 | ⚡: 0</div>
</div>  </div>
<canvas id="game" width="960" height="720"></canvas>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const player = { x: 400, y: 300, size: 20, speed: 2, hearts: 3, energy: 100, level: 11, score: 0 };
    const zombies = [], bullets = [], fireballs = [], iceballs = [], items = [], blades = [], downwardblades = [];
    let keys = {}, autoShoot = false, fireActive = false, iceActive = false;
    let fireTimer = 0, iceTimer = 0, frame = 0, gameOver = false;

    document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
    document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    let bladeActive = false;
let bladeEndTime = 0;
let bladeTimer = 0;

let bladeActive = false;
let bladeEndTime = 0;
let bladeTimer = 0;

let explosions = [];
player.hitTimer = 0;

function updateUI() {
  document.getElementById("score-top").innerText = `Điểm: ${player.score} | ❤️: ${player.hearts}`;
  document.getElementById("score-bottom").innerText = `Lv: ${player.level} | ⚡: ${player.energy}`;
}

    function shoot() {
      if (zombies.length === 0) return;
      const target = zombies.reduce((a, b) => (distance(a, player) < distance(b, player) ? a : b));
      const angle = Math.atan2(target.y - player.y, target.x - player.x);
      bullets.push({ x: player.x, y: player.y, dx: Math.cos(angle)*3, dy: Math.sin(angle)*3 });
    }
function activatebladeskill() {
  if (!bladeActive && player.energy >= 6) {
    bladeActive = true;
    bladeEndTime = Date.now() + 30000;
    bladeTimer = 0;
    player.energy -= 6;
    document.getElementById("bladeBtn").classList.add("active");
  }
}

function activateDownwardblades() {
  if (!bladeActive && player.energy >= 6) {
    bladeActive = true;
    bladeEndTime = Date.now() + 30000;
    bladeTimer = 0;
    player.energy -= 6;
    document.getElementById("swordBtn").classList.add("active");
  }
}




    function spawnZombie() {
      let x, y;
      const side = Math.floor(Math.random() * 4);
      if (side === 0) { x = -20; y = Math.random() * canvas.height; }
      else if (side === 1) { x = canvas.width + 20; y = Math.random() * canvas.height; }
      else if (side === 2) { x = Math.random() * canvas.width; y = -20; }
      else { x = Math.random() * canvas.width; y = canvas.height + 20; }
zombies.push({ x, y, radius: 15, canHit: true });
    }

    function distance(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }

    function dropItem(x, y) {
      if (Math.random() < 0.3) items.push({ x, y });
    }

 let fireEndTime = 0;
let iceEndTime = 0;

  function update() {
  // Xử lý kỹ năng Đao 🔪 tự tạo liên tục trong 30s
if (bladeActive) {
  if (Date.now() >= bladeEndTime) {
    bladeActive = false;
    blades.length = 0;
    document.getElementById("bladeBtn").classList.remove("active");
    document.getElementById("bladeBtn").innerText = "🔪 Đao";
  } else {
    const remain = Math.ceil((bladeEndTime - Date.now()) / 1000);
    document.getElementById("bladeBtn").innerText = `🔪 ${remain}s`;

    if (bladeTimer++ > 120) { // mỗi 2s tạo 1 đao
      bladeTimer = 0;
      const angle = Math.random() * Math.PI * 2;
      blades.push({
        angle,
        radius: 60,
        state: 'orbit',
        delay: 30,
        target: null,
        x: player.x,
        y: player.y
      });
    }
  }
}
// Cập nhật kỹ năng kiếm
if (bladeActive) {
  if (Date.now() >= bladeEndTime) {
    bladeActive = false;
    downwardblades.length = 0;
    document.getElementById("swordBtn").classList.remove("active");
    document.getElementById("swordBtn").innerText = "⚔️ Kiếm";
  } else {
    const remain = Math.ceil((bladeEndTime - Date.now()) / 1000);
    document.getElementById("swordBtn").innerText = `⚔️ ${remain}s`;

    if (bladeTimer++ > 120) {
      bladeTimer = 0;
      const spacing = canvas.width / 6;
      const x = spacing * (1 + Math.floor(Math.random() * 5));
      downwardblades.push({
        x,
        y: 100,
        delay: 30,
        state: 'waiting',
        target: null
      });
    }
  }
}

  if (gameOver) return;

  if (keys.w) player.y -= player.speed;
  if (keys.s) player.y += player.speed;
  if (keys.a) player.x -= player.speed;
  if (keys.d) player.x += player.speed;

  if (autoShoot && frame % 50 === 0) shoot();

  // === Kỹ năng LỬA ===
  if (fireActive) {
    const remaining = Math.ceil((fireEndTime - Date.now()) / 1000);
    const fireBtn = document.getElementById("fireBtn");
    if (remaining > 0) {
      fireBtn.innerText = `🔥 ${remaining}s`;
    } else {
      fireActive = false;
fireballs.length = 0;
fireBtn.innerText = "🔥 Lửa";
fireBtn.classList.remove("active");

    }
  }

  // === Kỹ năng BĂNG ===
  if (iceActive) {
    const remaining = Math.ceil((iceEndTime - Date.now()) / 1000);
    const iceBtn = document.getElementById("iceBtn");
    if (remaining > 0) {
      iceBtn.innerText = `❄️ ${remaining}s`;
    } else {
     iceActive = false;
iceballs.length = 0;
iceBtn.innerText = "❄️ Băng";
iceBtn.classList.remove("active");
    }
  }


  bullets.forEach((b, i) => {
    b.x += b.dx;
    b.y += b.dy;
    zombies.forEach((z, zi) => {
      if (distance(b, z) < 20) {
      explosions.push({ x: z.x, y: z.y, radius: 0, life: 20 });
        zombies.splice(zi, 1);
        bullets.splice(i, 1);
        player.score++;
        dropItem(z.x, z.y);
      }
    });
  });

  zombies.forEach((z, zi) => {
    const angle = Math.atan2(player.y - z.y, player.x - z.x);
    z.x += Math.cos(angle) * 1;
    z.y += Math.sin(angle) * 1;
    if (distance(z, player) < z.radius + player.size) {
  if (z.canHit) {
    player.hearts--;
    explosions.push({ x: z.x, y: z.y, radius: 0, life: 20 });
    z.canHit = false;

    // Cho phép zombie đánh lại sau 500ms
    setTimeout(() => { z.canHit = true; }, 500);

    if (player.hearts <= 0) {
      gameOver = true;
      document.getElementById("gameOverPanel").style.display = "flex";
    }
  }

  // đẩy zombie ra khỏi player
  const dx = z.x - player.x;
  const dy = z.y - player.y;
  const angle = Math.atan2(dy, dx);
  const pushBack = (z.radius + player.size - distance(z, player)) + 1;
  z.x += Math.cos(angle) * pushBack;
  z.y += Math.sin(angle) * pushBack;
}

  });

  // Lửa
  fireballs.forEach(f => {
    f.angle += 0.05;
    f.x = player.x + Math.cos(f.angle) * f.radius;
    f.y = player.y + Math.sin(f.angle) * f.radius;
    zombies.forEach((z, zi) => {
      if (distance(f, z) < 25) {
        zombies.splice(zi, 1);
        player.score++;
        dropItem(z.x, z.y);
      }
    });
  });

  // Băng
  iceballs.forEach(f => {
    f.angle += 0.03;
    f.x = player.x + Math.cos(f.angle) * f.radius;
    f.y = player.y + Math.sin(f.angle) * f.radius;
    zombies.forEach((z, zi) => {
      if (distance(f, z) < 30) {
        zombies.splice(zi, 1);
        player.score++;
        dropItem(z.x, z.y);
      }
    });
  });

  // Kiếm xoay
  blades.forEach((s, si) => {
  if (s.state === "orbit") {
  s.delay--;
  s.angle += 0.1;
  s.x = player.x + Math.cos(s.angle) * s.radius;
  s.y = player.y + Math.sin(s.angle) * s.radius;

  if (s.delay <= 0 && zombies.length > 0) {
    s.target = zombies[Math.floor(Math.random() * zombies.length)];
    s.state = "fly";
  }
}

  else if (s.state === "fly") {
    if (!s.target) return;
    const dx = s.target.x - s.x;
    const dy = s.target.y - s.y;
    const angle = Math.atan2(dy, dx);
    s.x += Math.cos(angle) * 4;
    s.y += Math.sin(angle) * 4;

    if (distance(s, s.target) < 25) {
      const idx = zombies.indexOf(s.target);
      if (idx !== -1) zombies.splice(idx, 1);
      blades.splice(si, 1);
      player.score++;
      dropItem(s.target.x, s.target.y);
    }
  }
});




  // Kiếm cắm
  downwardblades.forEach((s, si) => {
  if (s.state === 'waiting') {
    s.delay--;
    if (s.delay <= 0 && zombies.length > 0) {
      s.target = zombies[Math.floor(Math.random() * zombies.length)];
      s.state = 'fly';
    }
  } else if (s.state === 'fly') {
    if (!s.target) return;
    const dx = s.target.x - s.x;
    const dy = s.target.y - s.y;
    const angle = Math.atan2(dy, dx);
    s.x += Math.cos(angle) * 6;
    s.y += Math.sin(angle) * 6;
    if (distance(s, s.target) < 25) {
      const idx = zombies.indexOf(s.target);
      if (idx !== -1) zombies.splice(idx, 1);
      downwardblades.splice(si, 1);
      player.score++;
      dropItem(s.target.x, s.target.y);
    }
  }
});




  // Nhặt item ⚡
  items.forEach((it, ii) => {
    if (distance(it, player) < 20) {
      player.energy++;
      items.splice(ii, 1);
    }
  });

  if (player.score >= player.level * 100) {
  if (player.hitTimer > 0) player.hitTimer--;
    player.level++;
    player.hearts++;
    
  }
  explosions.forEach((e, i) => {
  e.radius += 2;
  e.life--;
  if (e.life <= 0) explosions.splice(i, 1);
});

  updateUI();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.beginPath();
ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
ctx.fillStyle = (player.hitTimer % 10 < 5) ? "#ff4c4c" : "#00ff00";
ctx.fill();


  bullets.forEach(b => {
    ctx.beginPath();
    ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
    ctx.fillStyle = "yellow";
    ctx.fill();
  });

  zombies.forEach(z => {
    ctx.beginPath();
    ctx.arc(z.x, z.y, 15, 0, Math.PI * 2);
    ctx.fillStyle = "hotpink";
    ctx.fill();
    ctx.fillText("🧟", z.x - 6, z.y + 5);
  });

  fireballs.forEach(f => {
    ctx.beginPath();
    ctx.arc(f.x, f.y, 10, 0, Math.PI * 2);
    ctx.fillStyle = "orange";
    ctx.fill();
  });

  iceballs.forEach(f => {
    ctx.beginPath();
    ctx.arc(f.x, f.y, 12, 0, Math.PI * 2);
    ctx.fillStyle = "lightblue";
    ctx.fill();
  });

  blades.forEach(s => {
  ctx.save();
  ctx.font = '20px serif';
  ctx.globalAlpha = 1;
  ctx.fillText('🔪', s.x - 10, s.y + 10);
  ctx.restore();
});


  downwardblades.forEach(s => {
  const opacity = s.appearFrame > 0 ? 1 - s.appearFrame / 30 : 1;
  const scale = s.appearFrame > 0 ? 0.6 + 0.4 * (1 - s.appearFrame / 30) : 1;

  ctx.save();
  ctx.globalAlpha = opacity;
  ctx.translate(s.x, s.y);
  ctx.scale(scale, scale);
  ctx.font = '22px serif';
  ctx.fillText('⚔️', -10, 10); // vẽ icon kiếm
  ctx.restore();

  if (s.appearFrame > 0) s.appearFrame--;
});

explosions.forEach(e => {
  ctx.beginPath();
  ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(255, 200, 0, ${e.life / 20})`;
  ctx.fill();
});

  items.forEach(it => {
    ctx.fillText("⚡", it.x - 5, it.y + 5);
  });
}

// CSS:
const style = document.createElement('style');
style.innerHTML = `.active { outline: 2px solid gold; border-radius: 8px; }`;
document.head.appendChild(style);

// Nút chơi lại khi thua
const panel = document.createElement("div");
panel.id = "gameOverPanel";
panel.style = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#222;padding:30px;color:white;display:none;flex-direction:column;align-items:center;border-radius:10px";
panel.innerHTML = `<h2>Game Over</h2><button onclick='location.reload()' style='margin-top:10px;padding:10px 20px;'>Chơi lại</button>`;
document.body.appendChild(panel);

    function loop() {
      update();
      draw();
      frame++;
      if (frame % 200 === 0) spawnZombie();
      requestAnimationFrame(loop);
    }

    document.getElementById("autoBtn").onclick = () => {
  autoShoot = !autoShoot;
  const btn = document.getElementById("autoBtn");
  if (autoShoot) {
    btn.classList.add("active");
  } else {
    btn.classList.remove("active");
  }
};


    // === Cập nhật nút kích hoạt kỹ năng dùng thời gian thực ===
document.getElementById("fireBtn").onclick = () => {
  if (!fireActive && player.energy >= 5) {
    fireActive = true;
    fireballs.length = 0;
    [0, Math.PI].forEach(a => fireballs.push({ angle: a, radius: 40 }));
    fireEndTime = Date.now() + 30000;
    player.energy -= 5;
    const btn = document.getElementById("fireBtn");
    btn.classList.add("active");
  }
};

document.getElementById("iceBtn").onclick = () => {
  if (!iceActive && player.level >= 10 && player.energy >= 8) {
    iceActive = true;
    iceballs.length = 0;
    [0, Math.PI/2, Math.PI, Math.PI*3/2].forEach(a => {
      iceballs.push({ angle: a, radius: 60 });
    });
    iceEndTime = Date.now() + 30000;
    player.energy -= 8;
    const btn = document.getElementById("iceBtn");
    btn.classList.add("active");
  }
};


    document.getElementById("bladeBtn").onclick = () => activatebladeskill();
    document.getElementById("swordBtn").onclick = () => activateDownwardblades();

    spawnZombie();
    loop();
  </script>
</body>
</html>
